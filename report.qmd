---
title: Numerical ecology report
author: Lucien Bastin
date: 2025-11-07
format: 
  html:
    fig-width: 10
    fig-height: 6
knitr:
  opts_chunk:
    message: FALSE
    warning: FALSE
embed-resources: TRUE
lightbox: TRUE
toc: TRUE
toc-location: right-body
df-print: kable
---

# Libraries

```{r}
library(adespatial)
library(dplyr)
library(GGally)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(here)
library(pals)
library(readr)
library(rnaturalearth)
library(tibble)
library(tidyr)
library(vegan)
library(viridis)
```

```{r}
source(here("R/triplot.rda.R"))
```

# Load data

## Initial dataset

Variables we have access to :

-   Station

-   Replicate

-   Study year

-   Latitude

-   Longitude

-   Salinity

-   Species abundances

```{r}
data <- read_csv(here("Data/NBI_projects_data_florida.csv")) |>
  select(
    station,
    infaunaReplicate,
    latitude,
    longitude,
    depth,
    collectionDate,
    studyName,
    salinity,
    abundance,
    taxon
  ) |>
  mutate(latitude = round(latitude, 2), longitude = round(longitude, 2)) |>
  mutate(
    year = substr(studyName, 1, 4),
    ID = factor(paste(latitude, longitude, sep = "-")),
    ID = as.integer(ID)
  ) |>
  mutate(sample = paste(year, ID, infaunaReplicate, sep = "-"))
```

Here's what the data table looks like :

```{r}
head(data)
```

## Select common stations for each year

Let's look at a simple map of the stations :

Here we group together the rows that have the same latitude and longitude and re-assign them a station number.

```{r}
stations <- data |>
  select(ID, latitude, longitude, depth, studyName) |>
  group_by(ID, studyName) |>
  summarize(across(c(latitude, longitude, depth), mean))
```

Plot a map for each survey year :

```{r}
ggplot(stations, aes(x = longitude, y = latitude, label = ID)) +
  geom_text() +
  facet_wrap(vars(studyName)) +
  theme_bw()
```

As we can see, some stations were only sampled for one or two survey years. I would like to look at temporal dynamics for the stations so I will only take into account stations that were sampled each year.

Select stations that appear three times (once for each year) in the dataset :

```{r}
stations <- stations |>
  group_by(ID) |>
  filter(n() == 3)
```

We can plot another map to check if everything is good : 

```{r}
ggplot(stations, aes(x = longitude, y = latitude, label = ID)) +
  geom_text() +
  facet_wrap(vars(studyName)) +
  theme_bw()
```

This looks OK, so we can filter the original dataset to only keep these stations :

```{r}
data <- data |>
  select(-c(year, station)) |>
  filter(ID %in% stations$ID) |>
  separate_wider_delim(
    cols = sample,
    delim = "-",
    names = c("year", "station", "replicate")
  )
```

```{r}
unique(sort(stations$ID))
unique(sort(data$ID))
```

## Make community table

I need a table of samples x species.

```{r}
data_abund <- data |>
  select(year, station, replicate, taxon, abundance) |>
  pivot_wider(names_from = taxon, values_from = abundance, values_fill = 0)
  #  |>
  # group_by(year, station) |>
  # summarize(across(-c(replicate), sum))
```

```{r}
head(data_abund[1:5])
```

## Make metadata table

Coordinates, depth and salinity for each station each year. Here there is no difference between replicates so we can pool them together.

```{r}
data_env <- data |>
  select(year, station, replicate, latitude, longitude, depth, salinity) |>
  group_by(year, station) |>
  summarize(across(c(latitude, longitude, depth, salinity), mean)) |>
  ungroup()
```

```{r}
head(data_env)
```

# Exploratory data analysis

## Map of the study site

```{r}
map_layer <- ne_countries(country = "united states of america", scale = "large")
```

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude)) +
  theme_test()
```

## Environmental variables

Take a look at depth and salinity for each station.

### Depths

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = depth), size = 2) +
  scale_color_gradientn(colours = rev(ocean.haline(200)[100:200])) +
  theme_test() +
  guides(
    color = guide_colorbar(reverse = TRUE)
  )
```

### Salinity by year

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = salinity), size = 2) +
  scale_color_viridis_c() +
  facet_wrap(vars(year)) +
  theme_test() +
  guides(
    color = guide_colorbar(reverse = TRUE)
  )
```

### Relationships between environmental variables

```{r}
ggpairs(
  data_env,
  aes(color = year, fill = year, alpha = 0.5),
  columns = c(4, 3, 5, 6),
  diag = list(continuous = "density")
) +
  theme_test()
```

## Species richness and total abundance

```{r}
data_env <- data_env |>
  mutate(
    richness = apply(data_abund[-c(1, 2)] > 0, 1, sum),
    abundance = apply(data_abund[-c(1, 2)], 1, sum)
  )
```

```{r}
plot_richness <- ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = richness), size = 2) +
  scale_color_viridis_c() +
  facet_wrap(vars(year), nrow = 3) +
  theme_test()
```

```{r}
plot_abundance <- ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = log(abundance)), size = 2) +
  scale_color_viridis_c() +
  facet_wrap(vars(year), nrow = 3) +
  theme_test()
```

```{r}
ggarrange(plot_richness, plot_abundance)
```

# Space and time interaction model

I will perform a MANOVA to look at the effect of time, space and their interaction.

```{r}
rda_text <- function(rda) {
  anov_rda <- anova(rda)
  rsq_rda <- RsquareAdj(rda)
  paste0(
    "F = ",
    round(anov_rda[1, 3], 2),
    "\n p-value = ",
    round(anov_rda[1, 4], 3),
    "\n adjusted RÂ² = ",
    round(rsq_rda$adj.r.squared, 3)
  )
}
```

Make the Helmert contrasts matrix for time and space as factors.

```{r}
year <- gl(3, 54)
station <- gl(18, 3, length = 162)
helmert <- model.matrix(
  ~ year * station,
  contrasts = list(year = "contr.helmert", station = "contr.helmert")
)[, -1]
```

```{r}
head(helmert[, 1:6])
```

Sort the dataframes so the stations are in order :

```{r}
data_abund <- data_abund |>
  arrange(year, as.numeric(station), replicate)

data_env <- data_env |>
  arrange(year, station, replicate)
```

Run the MANOVA :

```{r}
model <- adonis2(
  data_abund[-c(1, 2, 3)] ~ year * station,
  met = "eucl",
  by = "term"
)
```

Let's look at the results :

```{r}
model
```

Here we can see that space, time and their interaction all have a significant effect on the community structure.
We can represent these results with an RDA (here we pool replicates togeteher) :

```{r}
data_abund_pooled <- data_abund |>
  group_by(year, station) |>
  summarize(across(-1, sum))

rda_spacetime <- rda(
  decostand(data_abund_pooled[-c(1, 2)], "hellinger") ~ .,
  data_env[c(1, 2)] # Only keep year and station
)
sp_spacetime <- which(goodness(rda_spacetime)[, 2] >= 0.3)
```

```{r}
triplot.rda(rda_spacetime, select.spe = sp_spacetime)
mtext(adj = 0.97, line = -3, rda_text(rda_spacetime))
```

# Spatial structures (db-MEM)

Extract latitudes and longitudes of all stations, and compute distance matrix (same for each year).

```{r}
stations_xy <- subset(data_env, year == 1996)[c(3, 4)]
stations_dist <- dist(stations_xy)
```

Perform db-MEM :

```{r}
dbmem <- dbmem(stations_dist)
attributes(dbmem)$values
```