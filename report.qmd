---
title: Numerical ecology report
author: Lucien Bastin
date: 2025-11-07
format: 
  html:
    fig-width: 10
    fig-height: 6
knitr:
  opts_chunk:
    message: FALSE
    warning: FALSE
embed-resources: TRUE
lightbox: TRUE
toc: TRUE
toc-location: right-body
df-print: kable
---

# Libraries

```{r}
library(dplyr)
library(GGally)
library(ggplot2)
library(ggpubr)
library(here)
library(pals)
library(readr)
library(rnaturalearth)
library(tidyr)
library(viridis)
```

# Load data

## Initial dataset

Variables we have access to :

-   Station

-   Replicate

-   Study year

-   Latitude

-   Longitude

-   Salinity

-   Species abundances

```{r}
data <- read_csv(here("Data/NBI_projects_data_florida.csv")) |>
  select(
    station,
    infaunaReplicate,
    latitude,
    longitude,
    depth,
    collectionDate,
    studyName,
    salinity,
    abundance,
    taxon
  ) |>
  mutate(latitude = round(latitude, 2), longitude = round(longitude, 2)) |>
  mutate(
    year = substr(studyName, 1, 4),
    ID = factor(paste(latitude, longitude, sep = "-")),
    ID = as.integer(ID)
  ) |>
  mutate(sample = paste(year, ID, infaunaReplicate, sep = "-"))
```

Here's what the data table looks like :

```{r}
head(data)
```

## Select common stations for each year

Let's look at a simple map of the stations :

Here we group together the rows that have the same latitude and longitude and re-assign them a station number.

```{r}
stations <- data |>
  select(ID, latitude, longitude, depth, studyName) |>
  group_by(ID, studyName) |>
  summarize(across(c(latitude, longitude, depth), mean))
```

Plot a map for each survey year :

```{r}
ggplot(stations, aes(x = longitude, y = latitude, label = ID)) +
  geom_text() +
  facet_wrap(vars(studyName)) +
  theme_bw()
```

As we can see, some stations were only sampled for one or two survey years. I would like to look at temporal dynamics for the stations so I will only take into account stations that were sampled each year.

Select stations that appear three times (once for each year) in the dataset :

```{r}
stations <- stations |>
  group_by(ID) |>
  filter(n() == 3)
```

We can plot another map to check if everything is good : 

```{r}
ggplot(stations, aes(x = longitude, y = latitude, label = ID)) +
  geom_text() +
  facet_wrap(vars(studyName)) +
  theme_bw()
```

This looks OK, so we can filter the original dataset to only keep these stations :

```{r}
data <- data |>
  select(-c(year, station)) |>
  filter(ID %in% stations$ID) |>
  separate_wider_delim(
    cols = sample,
    delim = "-",
    names = c("year", "station", "replicate")
  )
```

```{r}
unique(sort(stations$ID))
unique(sort(data$ID))
```

## Make community table

I need a table of samples x species. We can also pool all replicates together for each station and year.

```{r}
data_abund <- data |>
  select(year, station, replicate, taxon, abundance) |>
  pivot_wider(names_from = taxon, values_from = abundance, values_fill = 0) |>
  group_by(year, station) |>
  summarize(across(-c(replicate), sum))
```

```{r}
head(data_abund[1:5])
```

## Make metadata table

Coordinates, depth and salinity for each station each year.

```{r}
data_env <- data |>
  select(year, station, replicate, latitude, longitude, depth, salinity) |>
  group_by(year, station) |>
  summarize(across(c(latitude, longitude, depth, salinity), mean)) |>
  ungroup()
```

```{r}
head(data_env)
```

# Exploratory data analysis

## Map of the study site

```{r}
map_layer <- ne_countries(country = "united states of america", scale = "large")
```

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude)) +
  theme_test()
```

## Environmental variables

Take a look at depth and salinity for each station.

### Depths

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = depth), size = 2) +
  scale_color_gradientn(colours = rev(ocean.haline(200)[100:200])) +
  theme_test() +
  guides(
    color = guide_colorbar(reverse = TRUE)
  )
```

### Salinity by year

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = salinity), size = 2) +
  scale_color_viridis_c() +
  facet_wrap(vars(year)) +
  theme_test() +
  guides(
    color = guide_colorbar(reverse = TRUE)
  )
```

### Relationships between environmental variables

```{r}
ggpairs(
  data_env,
  aes(color = year, fill = year, alpha = 0.5),
  columns = c(4, 3, 5, 6),
  diag = list(continuous = "density")
) +
  theme_test()
```

## Species richness and total abundance

```{r}
data_env <- data_env |>
  mutate(
    richness = apply(data_abund[-c(1, 2)] > 0, 1, sum),
    abundance = apply(data_abund[-c(1, 2)], 1, sum)
  )
```

```{r}
plot_richness <- ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = richness), size = 2) +
  scale_color_viridis_c() +
  facet_wrap(vars(year), nrow = 3) +
  theme_test()
```

```{r}
plot_abundance <- ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = log(abundance)), size = 2) +
  scale_color_viridis_c() +
  facet_wrap(vars(year), nrow = 3) +
  theme_test()
```

```{r}
ggarrange(plot_richness, plot_abundance)
```

# Community structure through the years

Split data tables in three (one for each year)

```{r}
abund_1996 <- data_abund |> filter(year == "1996")
abund_1997 <- data_abund |> filter(year == "1997")
abund_2000 <- data_abund |> filter(year == "2000")
```

```{r}
env_1996 <- data_env |> filter(year == "1996")
env_1997 <- data_env |> filter(year == "1997")
env_2000 <- data_env |> filter(year == "2000")
```

## Canonical analyses (RDA)

```{r}

```