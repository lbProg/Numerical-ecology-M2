---
title: Numerical ecology report
author: Lucien Bastin
date: 2025-11-07
format: 
  html:
    fig-width: 12
    fig-height: 8
knitr:
  opts_chunk:
    message: FALSE
    warning: FALSE
embed-resources: TRUE
lightbox: TRUE
toc: TRUE
toc-location: right-body
df-print: kable
bibliography: Bibliography/references.bib
csl: Bibliography/apa.csl
---

# Libraries

```{r}
library(adespatial)
library(cluster)
library(dplyr)
library(ecotraj)
library(GGally)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(here)
library(pals)
library(readr)
library(rnaturalearth)
library(stringr)
library(tibble)
library(tidyr)
library(vegan)
library(viridis)
```

```{r}
source("R/extract_rda.R")
```

```{r}
sessionInfo()
```

# Load data

## Initial dataset

Variables we have access to :

-   Station

-   Replicate

-   Study year

-   Latitude

-   Longitude

-   Salinity

-   Species abundances

```{r}
data <- read_csv(here("Data/NBI_projects_data_florida.csv")) |>
  select(
    station,
    infaunaReplicate,
    latitude,
    longitude,
    depth,
    collectionDate,
    studyName,
    salinity,
    abundance,
    taxon
  ) |>
  mutate(latitude = round(latitude, 2), longitude = round(longitude, 2)) |>
  mutate(
    year = substr(studyName, 1, 4),
    ID = factor(paste(latitude, longitude, sep = "-")),
    ID = as.integer(ID)
  ) |>
  mutate(sample = paste(year, ID, infaunaReplicate, sep = "-"))
```

Here's what the data table looks like :

```{r}
head(data)
```

## Select common stations for each year

Let's look at a simple map of the stations :

Here we group together the rows that have the same latitude and longitude and re-assign them a station number.

```{r}
stations <- data |>
  select(ID, latitude, longitude, depth, studyName) |>
  group_by(ID, studyName) |>
  summarize(across(c(latitude, longitude, depth), mean))
```

Plot a map for each survey year :

```{r}
ggplot(stations, aes(x = longitude, y = latitude, label = ID)) +
  geom_text() +
  facet_wrap(vars(studyName)) +
  theme_bw()
```

As we can see, some stations were only sampled for one or two survey years. I would like to look at temporal dynamics for the stations so I will only take into account stations that were sampled each year.

Select stations that appear three times (once for each year) in the dataset :

```{r}
stations <- stations |>
  group_by(ID) |>
  filter(n() == 3)
```

We can plot another map to check if everything is good :

```{r}
ggplot(stations, aes(x = longitude, y = latitude, label = ID)) +
  geom_text() +
  facet_wrap(vars(studyName)) +
  theme_bw()
```

This looks OK, so we can filter the original dataset to only keep these stations :

```{r}
data <- data |>
  select(-c(year, station)) |>
  filter(ID %in% stations$ID) |>
  separate_wider_delim(
    cols = sample,
    delim = "-",
    names = c("year", "station", "replicate")
  )
```

```{r}
unique(sort(stations$ID))
unique(sort(data$ID))
```

## Make community table

I need a table of samples x species.

```{r}
data_abund <- data |>
  select(year, station, replicate, taxon, abundance) |>
  pivot_wider(names_from = taxon, values_from = abundance, values_fill = 0)
```

```{r}
head(data_abund[1:7])
```

As we can see, there are some columns that refer to taxonomical levels above the species. I would prefer all my columns to be species or genuses, but here we have families and even orders. This makes me not want to decrease the taxonomic resolution because we would loose a LOT of information.

I will therefore remove all of those low-resolution taxonomic entries to only keep species. They all have in common an "(LPIL)" written after their name. We can use this to detect and remove them from the dataframe.

```{r}
sp <- colnames(data_abund[-c(1:3)])
regex <- "\\b[A-Z][a-z]* \\(LPIL\\)"

data_abund <- data_abund |>
  select(year, station, replicate, sp[str_detect(sp, regex) == FALSE])
```

```{r}
head(data_abund[1:7])
```

## Make metadata table

Coordinates, depth and salinity for each station each year. Here there is no difference between replicates so we can pool them together.

```{r}
data_env <- data |>
  select(year, station, replicate, latitude, longitude, depth, salinity) |>
  group_by(year, station) |>
  summarize(across(c(latitude, longitude, depth, salinity), mean)) |>
  ungroup()
```

```{r}
head(data_env)
```

# Exploratory data analysis

## Map of the study site

```{r}
map_layer <- ne_countries(country = "united states of america", scale = "large")
```

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude)) +
  geom_text_repel(
    data = data_env |> filter(year == "2000"),
    aes(x = longitude, y = latitude, label = station),
    seed = 1
  ) +
  theme_test()
```

## Environmental variables

Take a look at depth and salinity for each station.

### Depths

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(
    data = data_env,
    aes(x = longitude, y = latitude, color = depth),
    size = 2
  ) +
  geom_text_repel(
    data = data_env |> filter(year == "2000"),
    aes(x = longitude, y = latitude, label = station),
    seed = 1
  ) +
  scale_color_gradientn(colours = rev(ocean.haline(200)[100:200])) +
  theme_test() +
  guides(
    color = guide_colorbar(reverse = TRUE)
  )
```

All stations sampled have quite low depths (between 80cm and 5.8m). The most inland stations (24, 25, 29, 32 and 34) all have very low depths (less than 2m). Other stations have larger depths.

### Salinity by year

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = salinity), size = 2) +
  geom_text_repel(
    data = data_env,
    aes(x = longitude, y = latitude, label = station),
    seed = 1
  ) +
  scale_color_viridis_c() +
  facet_wrap(vars(year), nrow = 3) +
  theme_test() +
  guides(
    color = guide_colorbar(reverse = TRUE)
  )
```

Salinities were not recorded for all stations in 1997. For 1996 and 2000, we can observe large salinity differences between the stations. In 1996, stations 29, 32 and 34 have salinities around 25, while all other stations have salinities of 37. In 2000, the same phenomenon is visible for stations 32 and 34, which have salinities of 0 (although this may be du to a field sampling error).

This salinity difference is due to freshwater runoff in the northeast part of the Florida Bay [@kelble_salinity_2007].

### Relationships between environmental variables

```{r}
ggpairs(
  data_env,
  aes(color = year, fill = year, alpha = 0.5),
  columns = c(4, 3, 5, 6),
  diag = list(continuous = "density")
) +
  theme_test()
```

Depth show a negative correlation to longitude, but is not correlated to latitude. Salinity stays constant between the stations for each survey year, except for the three stations in the northeast that have lower salinities (as we saw before).
Salinity also doesn't vary depending on depth.

## Species richness and total abundance

```{r}
data_abund_pooled <- data_abund |>
  group_by(year, station) |>
  summarize(across(-1, sum))
```

Compute species richness and total abundance for each station and add them to the environmental dataframe.

```{r}
data_env <- data_env |>
  mutate(
    richness = apply(data_abund_pooled[-c(1, 2)] > 0, 1, sum),
    abundance = apply(data_abund_pooled[-c(1, 2)], 1, sum)
  )
```

Now we can make the two plots.

```{r}
plot_richness <- ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = richness), size = 2) +
  geom_text_repel(
    data = data_env,
    aes(x = longitude, y = latitude, label = station),
    seed = 1
  ) +
  scale_color_viridis_c() +
  facet_wrap(vars(year), nrow = 3) +
  theme_test()
```

```{r}
plot_abundance <- ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = log(abundance)), size = 2) +
  geom_text_repel(
    data = data_env,
    aes(x = longitude, y = latitude, label = station),
    seed = 1
  ) +
  scale_color_viridis_c() +
  facet_wrap(vars(year), nrow = 3) +
  theme_test()
```

```{r}
ggarrange(plot_richness, plot_abundance)
```

Specific richness tends to be lower in the northeast stations.
Total abundance doesn't really show any pattern.

## Aims of this study

How does the spatial structure of the Florida Bay macrobenthic communities evolve through time ? 
Can we observe different communities in the northeast stations (with the lowest salinity) and the rest of the Bay ?
Has there been a shift in community composition between 1996 and 2000 ?

# Space and time interaction model

## Qualitative model

I will perform a MANOVA to look at the effect of time, space and their interaction.

Make the Helmert contrasts matrix for time and space as factors.

```{r}
year <- gl(3, 54)
station <- gl(18, 3, length = 162)
helmert <- model.matrix(
  ~ year * station,
  contrasts = list(year = "contr.helmert", station = "contr.helmert")
)[, -1]
```

```{r}
head(helmert[, 1:6])
```

Sort the dataframes so the stations are in order :

```{r}
data_abund <- data_abund |>
  arrange(year, as.numeric(station), replicate)
```

Run the MANOVA :

```{r}
model <- adonis2(
  data_abund[-c(1, 2, 3)] ~ year * station,
  met = "eucl",
  by = "term"
)
```

Let's look at the results :

```{r}
model
```

Here we can see that space, time and their interaction all have a significant effect on the community structure. We can represent these results with an RDA (here we pool replicates togeteher) :

```{r}
rda_spacetime <- rda(
  decostand(data_abund_pooled[-c(1, 2)], "hellinger") ~ .,
  data_env[c(1, 2)] # Only keep year and station
)
sp_spacetime <- which(goodness(rda_spacetime)[, 2] >= 0.35)
```

```{r}
rda_coords <- extract_rda(rda_spacetime, select_spe = sp_spacetime)
rda_coords$site_scores <- as.data.frame(rda_coords$site_scores) |>
  mutate(year = data_env$year, station = data_env$station)
```

```{r}
ggplot() +
  geom_point(data = rda_coords$site_scores, aes(x = RDA1, y = RDA2, color = year)) +
  geom_segment(
    data = rda_coords$species_scores,
    aes(
      x = 0,
      y = 0,
      xend = RDA1,
      yend = RDA2
    ),
    arrow = arrow(length = unit(.15, 'cm')),
    color = "red",
    lwd = 0.3,
  ) +
  geom_point(
    data = rda_coords$centroids,
    aes(
      x = RDA1,
      y = RDA2
    ),
    color = "blue",
    shape = 18
  ) +
  geom_text_repel(
    data = rda_coords$centroids,
    aes(x = RDA1, y = RDA2, label = rownames(rda_coords$centroids)),
    color = "blue"
  ) +
  geom_text_repel(
    data = rda_coords$species_scores,
    aes(x = RDA1, y = RDA2, label = rownames(rda_coords$species_scores)),
    color = "red",
    size = 3
  ) +
  labs(
    x = paste0("RDA1 (", rda_coords$var_perc[1], "%)"),
    y = paste0("RDA2 (", rda_coords$var_perc[2], "%)")
  ) +
  annotate(
    "text",
    x = -0.5,
    y = -0.5,
    label = paste0(
      "F = ",
      rda_coords$F,
      "\np-value = ",
      rda_coords$p_value,
      "\nadjusted R² = ",
      rda_coords$r_sq_adj
    )
  ) +
  theme_test()
```

The first two RDA axes represents 19% of the total variance of the data. We can see that for 1996 and 1997, the sites are really close to eachother.

The RDA1 axis shows time differences between the years 1996-1997 and 2000. We can see that the relative abundance of *Oligochaeta* has decreased in 2000.

We can also see that for each year, two groups of stations appear : the stations 24, 25, 29, 32 and 34 (northeast stations) and the others. This could indicate that the northeast stations harbor different communities compared to the rest of the Florida Bay. For instance, these stations show a high relative abundance of the species *Phascolion strombi*, while the other stations show a low relative abundance for this species.

Furthermore, unlike the *Oliogchaete* whose relative abundance decreases in time, *P. strombi* is always associated to the northeast stations, no matter the year.

## Quantitative model

To further investigate the effect of space and time, I will consider them as quantitative variables. We can do this by taking the year value for time, and by using the latitude and longitude of the points for space.

Add the year as a quantitative variable to the environment dataframe :

```{r}
data_env$year_quant <- as.numeric(data_env$year)
```

Perform forward selection to find the most parcimonious model :

```{r}
data_abund_hell <- decostand(data_abund_pooled[-c(1, 2)], "hellinger")
```

```{r}
forward.sel(data_abund_hell, data_env |> select(latitude, longitude, year_quant))
```

The best model has all three variables.

```{r}
rda_quant <- rda(data_abund_hell ~ ., data = data_env |> select(latitude, longitude, year_quant))
anova(rda_quant)
```

Visualize the results :

```{r}
sp_quant <- which(goodness(rda_quant)[, 2] >= 0.35)
rda_coords <- extract_rda(rda_quant, select_spe = sp_quant)
rda_coords$site_scores <- as.data.frame(rda_coords$site_scores) |>
  mutate(year = data_env$year, station = data_env$station)
```

```{r}
ggplot() +
  geom_point(data = rda_coords$site_scores, aes(x = RDA1, y = RDA2, color = year)) +
  geom_segment(
    data = rda_coords$species_scores,
    aes(
      x = 0,
      y = 0,
      xend = RDA1,
      yend = RDA2
    ),
    arrow = arrow(length = unit(.15, 'cm')),
    color = "red",
    lwd = 0.3,
  ) +
  geom_segment(
    data = rda_coords$env_scores,
    aes(
      x = 0,
      y = 0,
      xend = RDA1,
      yend = RDA2
    ),
    arrow = arrow(length = unit(.15, 'cm')),
    color = "blue",
    lwd = 0.3,
  ) +
  geom_text_repel(
    data = rda_coords$env_scores,
    aes(x = RDA1, y = RDA2, label = rownames(rda_coords$env_scores)),
    color = "blue"
  ) +
  geom_text_repel(
    data = rda_coords$species_scores,
    aes(x = RDA1, y = RDA2, label = rownames(rda_coords$species_scores)),
    color = "red",
    size = 3
  ) +
  labs(
    x = paste0("RDA1 (", rda_coords$var_perc[1], "%)"),
    y = paste0("RDA2 (", rda_coords$var_perc[2], "%)")
  ) +
  annotate(
    "text",
    x = -0.5,
    y = -0.5,
    label = paste0(
      "F = ",
      rda_coords$F,
      "\np-value = ",
      rda_coords$p_value,
      "\nadjusted R² = ",
      rda_coords$r_sq_adj
    )
  ) +
  theme_test()
```

Here we can better see the separation between the years 1996, 1997 and 2000. However, this model and this representation are not better than the qualitative model.

But from this RDA it looks like there is a continuous shift in the community between 1996 and 2000. We could imagine two sets of points for 1998 and 1999 that would fill the empty space in the plot.

## db-MEM analysis

I will also compute a db-MEM to see if there are spatial structures that are more complex than just the x/y coordinates.

Extract latitudes and longitudes of all stations, and get the db-MEMs :

```{r}
stations_xy <- subset(data_env, year == 1996)[c(3, 4)]
dbmem <- dbmem(stations_xy)
```

Add these MEMs to the env dataframe :

```{r}
data_env <- cbind(data_env, as.data.frame(dbmem))
```

Let's visualize the 7 MEMs :

```{r}
data_MEM <- data_env |>
  pivot_longer(MEM1:MEM7, names_to = "MEM", values_to = "value")
```

```{r}
ggplot(data_MEM, aes(x = longitude, y = latitude, size = abs(value), color = factor(sign(value)))) +
  geom_point() +
  facet_wrap(vars(MEM)) +
  theme_test()
```

Before we perform db-MEM analysis, we have to check if there is a linear trend in the data :

```{r}
anova(rda(data_abund_hell[1:18, ], stations_xy))
anova(rda(data_abund_hell[19:36, ], stations_xy))
anova(rda(data_abund_hell[37:54, ], stations_xy))
```

There is a significant linear trend for each year, so we have to detrend the data before db-MEM.

```{r}
data_abund_det_96 <- resid(lm(as.matrix(data_abund_hell[1:18, ]) ~ ., data = stations_xy))
data_abund_det_97 <- resid(lm(as.matrix(data_abund_hell[19:36, ]) ~ ., data = stations_xy))
data_abund_det_00 <- resid(lm(as.matrix(data_abund_hell[37:54, ]) ~ ., data = stations_xy))
```

Now we can run the db-MEM analysis :

```{r}
dbmem_96 <- rda(data_abund_det_96 ~ ., data_env |> filter(year == "1996") |> select(MEM1:MEM7))
dbmem_97 <- rda(data_abund_det_97 ~ ., data_env |> filter(year == "1997") |> select(MEM1:MEM7))
dbmem_00 <- rda(data_abund_det_00 ~ ., data_env |> filter(year == "2000") |> select(MEM1:MEM7))
```

Let's check the global model significance :

```{r}
anova(dbmem_96)
anova(dbmem_97)
anova(dbmem_00)
```

None of the models are significant, so we can't proceed to selection of the MEMs. The db-MEM analysis was unsuccessful and can't help us investigate spatial structures.

## Clustering analysis

As a backup, we can perform a clustering of the stations each year. This will reveal which stations have similar communities and might highlight spatial structures.

There are multiple ways to cluster the stations together. We can compute the cophenetic correlation coefficient to find out which one is the "best".

```{r}
methods = c("single", "complete", "average", "ward.D", "ward.D2")
```

```{r}
cophenetic_cors <- data.frame(expand.grid(
  year = c("1996", "1997", "2000"),
  method = methods
)) |>
  arrange(year, method)
```

Function to get the Hellinger distance matrix for a year (`data` will be a Hellinger-transformed abundance dataframe).

```{r}
hell_dist_year <- function(data, year) {
  # Takes year as 1/2/3 and returns the hellinger distance between the stations
  vegdist(
    data[(1 + 18 * (year - 1)):(18 + 18 * (year - 1)), ],
    "euclidean"
  )
}
```

Now we can compute the cophenetic correlation for each clustering method each year.

```{r}
coph <- c()

for (year in 1:3) {
  # For each year, compute the hellinger distance matrix between sites
  dist <- hell_dist_year(data_abund_hell, year)

  for (m in 1:length(methods)) {
    # For each clustering method, compute the cophenetic correlation coefficient
    clust <- hclust(
      dist,
      method = methods[m]
    )

    coph <- append(coph, round(cor(dist, cophenetic(clust)), 2))
  }
}

cophenetic_cors$coph <- coph
```

```{r}
cophenetic_cors
```

The average clustering gives the best cophenetic correlation for every year. We can check what it looks like :

```{r}
hell_dist_96 <- vegdist(data_abund_hell[1:18, ], "euclidean")
hell_dist_97 <- vegdist(data_abund_hell[19:36, ], "euclidean")
hell_dist_00 <- vegdist(data_abund_hell[37:54, ], "euclidean")
```

```{r}
clust_96 <- hclust(hell_dist_96, method = "average")
clust_97 <- hclust(hell_dist_97, method = "average")
clust_00 <- hclust(hell_dist_00, method = "average")
```

```{r}
par(mfrow = c(1, 3))
plot(clust_96, labels = data_env$station[1:18])
plot(clust_97, labels = data_env$station[1:18])
plot(clust_00, labels = data_env$station[1:18])
```

Choose the best number of clusters using the silhouette indicator :

```{r}
silhouettes_96 <- rep(0, 18)
for (i in 2:(length(silhouettes_96) - 1)) {
  s <- summary(silhouette(cutree(clust_96, k = i), hell_dist_96))$avg.width
  silhouettes_96[i] <- s
}
```

```{r}
silhouettes <- data.frame(expand.grid(
  year = c("1996", "1997", "2000"),
  k = seq(2, 17)
)) |>
  arrange(year, k)
```

Compute the silhouette value each year for all possible numbers of clusters (between 2 and 17).

```{r}
sil <- c()

for (year in 1:3) {
  dist <- hell_dist_year(data_abund_hell, year)
  
  for (k in 2:17) {
    cut <- cutree(c(clust_96, clust_97, clust_00)[1 + 7 * (year - 1)], k = k)
    s <- summary(silhouette(cut, dist))$avg.width
    sil <- append(sil, s)
  }
}

silhouettes$silhouette <- sil
```

```{r}
ggplot(silhouettes, aes(x = k, y = sil)) +
  geom_bar(stat = "identity", width = 0.5) +
  facet_wrap(vars(year)) +
  theme_test()
```

According to the silhouette metric, the best number of clusters are 4 for 1996 and 1997, and 7 for 2000.

Let's represent these clusters on a map of the stations :

```{r}
data_clust <- data_env |>
  select(year, station, longitude, latitude) |>
  mutate(
    cluster = c(
      unname(cutree(clust_96, 4)),
      unname(cutree(clust_97, 4)),
      unname(cutree(clust_00, 7))
    )
  )
```

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(
    data = data_clust,
    aes(x = longitude, y = latitude, color = factor(cluster)),
    size = 3
  ) +
  geom_text_repel(
    data = data_env,
    aes(x = longitude, y = latitude, label = station),
    seed = 1
  ) +
  facet_wrap(vars(year), nrow = 3) +
  theme_test()
```

The clusterings may reveal spatial structures (since stations close to eachother tend to be in the same clusters).
For instance, stations [29, 32, 34], [7, 8], [20, 23, 26, 28], [1, 5, 6, 14] and [11, 18] are always in the same cluster each year.
The northeast stations (29, 32, 34) therefore present different communities compared to the rest of the Florida Bay.

# Evolution of the communities through time

To define ecological trajectories, we need the entities (stations) and times (years).
For the distance matrix, we will use the hellinger distance between the sites

```{r}
data_abund_hell <- decostand(data_abund_pooled[-c(1, 2)], "hellinger")
dist_hell <- vegdist(data_abund_hell, "euclidean")
```

Make a color palette :

```{r}
station_cols <- data.frame(
  station = sort(as.numeric(unique(data_env$station))),
  col = viridis(18) #pals::alphabet(18)
) |>
  mutate(station = as.character(station)) |>
  arrange(station)
```

Now we can define the trajectories using package `ecotraj`.

```{r}
trajs <- defineTrajectories(
  dist_hell,
  sites = data_env$station,
  times = as.numeric(data_env$year)
)
```

We can represent the trajectories in 2D space using a PCoA :

```{r}
par(mfrow = c(1, 1))
pcoa <- trajectoryPCoA(trajs, traj.colors = station_cols$col, lwd = 2, length = 0.1)
text(pcoa$points[1:18, 1], pcoa$points[1:18, 2], unique(data_env$station))
station_cols <- station_cols |> arrange(as.numeric(station))
legend(
  x = 0.6,
  y = 0.45,
  col = station_cols$col,
  legend = unique(station_cols$station),
  bty = "n",
  lty = 1,
  lwd = 3,
  y.intersp = 0.6
)
```

The first two PCoA axes account for 20% of the total variance of the data. All trajectories follow the same pattern : a shift on PCoA2 (negative or positive) followed by a shift towards positive values of PCoA1.
We can also see that the trajectories of the northeast stations (24, 25, 29, 32, 34) are separated from the others on the PCoA space, but they follow the same general trend.

Compute trajectory metrics :

```{r}
metrics <- trajectoryMetrics(trajs) |>
  pivot_longer(length:internal_variance, names_to = "metric", values_to = "value") |>
  mutate(trajectory = factor(trajectory, levels = order(as.numeric(trajectory))))
```

```{r}
ggplot(metrics, aes(x = trajectory, y = value)) +
  geom_bar(stat = "identity") +
  facet_wrap(vars(metric), scales = "free") +
  theme_test()
```

```{r}
trajectoryConvergence(trajs, type = "pairwise.symmetric") # Doesn't work with 3 points ?
```

# References