---
title: Numerical ecology report
author: Lucien Bastin
date: 2025-11-07
format: 
  html:
    fig-width: 10
    fig-height: 6
knitr:
  opts_chunk:
    message: FALSE
    warning: FALSE
embed-resources: TRUE
lightbox: TRUE
toc: TRUE
toc-location: right-body
df-print: kable
---

# Libraries

```{r}
library(adespatial)
library(dplyr)
library(GGally)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(here)
library(pals)
library(readr)
library(rnaturalearth)
library(tibble)
library(tidyr)
library(vegan)
library(viridis)
```

```{r}
source("R/extract_rda.R")
```

# Load data

## Initial dataset

Variables we have access to :

-   Station

-   Replicate

-   Study year

-   Latitude

-   Longitude

-   Salinity

-   Species abundances

```{r}
data <- read_csv(here("Data/NBI_projects_data_florida.csv")) |>
  select(
    station,
    infaunaReplicate,
    latitude,
    longitude,
    depth,
    collectionDate,
    studyName,
    salinity,
    abundance,
    taxon
  ) |>
  mutate(latitude = round(latitude, 2), longitude = round(longitude, 2)) |>
  mutate(
    year = substr(studyName, 1, 4),
    ID = factor(paste(latitude, longitude, sep = "-")),
    ID = as.integer(ID)
  ) |>
  mutate(sample = paste(year, ID, infaunaReplicate, sep = "-"))
```

Here's what the data table looks like :

```{r}
head(data)
```

## Select common stations for each year

Let's look at a simple map of the stations :

Here we group together the rows that have the same latitude and longitude and re-assign them a station number.

```{r}
stations <- data |>
  select(ID, latitude, longitude, depth, studyName) |>
  group_by(ID, studyName) |>
  summarize(across(c(latitude, longitude, depth), mean))
```

Plot a map for each survey year :

```{r}
ggplot(stations, aes(x = longitude, y = latitude, label = ID)) +
  geom_text() +
  facet_wrap(vars(studyName)) +
  theme_bw()
```

As we can see, some stations were only sampled for one or two survey years. I would like to look at temporal dynamics for the stations so I will only take into account stations that were sampled each year.

Select stations that appear three times (once for each year) in the dataset :

```{r}
stations <- stations |>
  group_by(ID) |>
  filter(n() == 3)
```

We can plot another map to check if everything is good : 

```{r}
ggplot(stations, aes(x = longitude, y = latitude, label = ID)) +
  geom_text() +
  facet_wrap(vars(studyName)) +
  theme_bw()
```

This looks OK, so we can filter the original dataset to only keep these stations :

```{r}
data <- data |>
  select(-c(year, station)) |>
  filter(ID %in% stations$ID) |>
  separate_wider_delim(
    cols = sample,
    delim = "-",
    names = c("year", "station", "replicate")
  )
```

```{r}
unique(sort(stations$ID))
unique(sort(data$ID))
```

## Make community table

I need a table of samples x species.

```{r}
data_abund <- data |>
  select(year, station, replicate, taxon, abundance) |>
  pivot_wider(names_from = taxon, values_from = abundance, values_fill = 0)
  #  |>
  # group_by(year, station) |>
  # summarize(across(-c(replicate), sum))
```

```{r}
head(data_abund[1:5])
```

## Make metadata table

Coordinates, depth and salinity for each station each year. Here there is no difference between replicates so we can pool them together.

```{r}
data_env <- data |>
  select(year, station, replicate, latitude, longitude, depth, salinity) |>
  group_by(year, station) |>
  summarize(across(c(latitude, longitude, depth, salinity), mean)) |>
  ungroup()
```

```{r}
head(data_env)
```

# Exploratory data analysis

## Map of the study site

```{r}
map_layer <- ne_countries(country = "united states of america", scale = "large")
```

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude)) +
  theme_test()
```

## Environmental variables

Take a look at depth and salinity for each station.

### Depths

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = depth), size = 2) +
  scale_color_gradientn(colours = rev(ocean.haline(200)[100:200])) +
  theme_test() +
  guides(
    color = guide_colorbar(reverse = TRUE)
  )
```

### Salinity by year

```{r}
ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = salinity), size = 2) +
  scale_color_viridis_c() +
  facet_wrap(vars(year)) +
  theme_test() +
  guides(
    color = guide_colorbar(reverse = TRUE)
  )
```

### Relationships between environmental variables

```{r}
ggpairs(
  data_env,
  aes(color = year, fill = year, alpha = 0.5),
  columns = c(4, 3, 5, 6),
  diag = list(continuous = "density")
) +
  theme_test()
```

## Species richness and total abundance

```{r}
data_abund_pooled <- data_abund |>
  group_by(year, station) |>
  summarize(across(-1, sum))
```

```{r}
data_env <- data_env |>
  mutate(
    richness = apply(data_abund_pooled[-c(1, 2)] > 0, 1, sum),
    abundance = apply(data_abund_pooled[-c(1, 2)], 1, sum)
  )
```

```{r}
plot_richness <- ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = richness), size = 2) +
  scale_color_viridis_c() +
  facet_wrap(vars(year), nrow = 3) +
  theme_test()
```

```{r}
plot_abundance <- ggplot(map_layer) +
  geom_sf() +
  coord_sf(xlim = c(-80, -82), ylim = c(24.5, 25.5), expand = c(0, 0)) +
  geom_point(data = data_env, aes(x = longitude, y = latitude, color = log(abundance)), size = 2) +
  scale_color_viridis_c() +
  facet_wrap(vars(year), nrow = 3) +
  theme_test()
```

```{r}
ggarrange(plot_richness, plot_abundance)
```

# Space and time interaction model

## Qualitative model

I will perform a MANOVA to look at the effect of time, space and their interaction.

Make the Helmert contrasts matrix for time and space as factors.

```{r}
year <- gl(3, 54)
station <- gl(18, 3, length = 162)
helmert <- model.matrix(
  ~ year * station,
  contrasts = list(year = "contr.helmert", station = "contr.helmert")
)[, -1]
```

```{r}
head(helmert[, 1:6])
```

Sort the dataframes so the stations are in order :

```{r}
data_abund <- data_abund |>
  arrange(year, as.numeric(station), replicate)

# data_env <- data_env |>
#   arrange(year, station, replicate)
```

Run the MANOVA :

```{r}
model <- adonis2(
  data_abund[-c(1, 2, 3)] ~ year * station,
  met = "eucl",
  by = "term"
)
```

Let's look at the results :

```{r}
model
```

Here we can see that space, time and their interaction all have a significant effect on the community structure.
We can represent these results with an RDA (here we pool replicates togeteher) :

```{r}
rda_spacetime <- rda(
  decostand(data_abund_pooled[-c(1, 2)], "hellinger") ~ .,
  data_env[c(1, 2)] # Only keep year and station
)
sp_spacetime <- which(goodness(rda_spacetime)[, 2] >= 0.35)
```

```{r}
rda_coords <- extract_rda(rda_spacetime, select_spe = sp_spacetime)
rda_coords$site_scores <- as.data.frame(rda_coords$site_scores) |>
  mutate(year = data_env$year, station = data_env$station)
```

```{r}
ggplot() +
  geom_point(data = rda_coords$site_scores, aes(x = RDA1, y = RDA2, color = year)) +
  geom_segment(
    data = rda_coords$species_scores,
    aes(
      x = 0,
      y = 0,
      xend = RDA1,
      yend = RDA2
    ),
    arrow = arrow(length = unit(.15, 'cm')),
    color = "red",
    lwd = 0.3,
  ) +
  geom_point(
    data = rda_coords$centroids,
    aes(
      x = RDA1,
      y = RDA2
    ),
    color = "blue",
    shape = 18
  ) +
  geom_text_repel(
    data = rda_coords$centroids,
    aes(x = RDA1, y = RDA2, label = rownames(rda_coords$centroids)),
    color = "blue"
  ) +
  geom_text_repel(
    data = rda_coords$species_scores,
    aes(x = RDA1, y = RDA2, label = rownames(rda_coords$species_scores)),
    color = "red",
    size = 3
  ) +
  labs(
    x = paste0("RDA1 (", rda_coords$var_perc[1], "%)"),
    y = paste0("RDA2 (", rda_coords$var_perc[2], "%)")
  ) +
  annotate(
    "text",
    x = -0.5,
    y = -0.5,
    label = paste0(
      "F = ",
      rda_coords$F,
      "\np-value = ",
      rda_coords$p_value,
      "\nadjusted R² = ",
      rda_coords$r_sq_adj
    )
  ) +
  theme_test()
```

## Quantitative model

To further investigate the effect of space and time, I will consider them as quantitative variables. We can do this by taking the year value for time, and by using the latitude and longitude of the points for space.

Add the year as a quantitative variable to the environment dataframe :

```{r}
data_env$year_quant <- as.numeric(data_env$year)
```

Perform forward selection to find the most parcimonious model :

```{r}
data_abund_hell <- decostand(data_abund_pooled[-c(1, 2)], "hellinger")
forward.sel(data_abund_hell, data_env |> select(latitude, longitude, year_quant))
```

The best model has all three variables.

```{r}
rda_quant <- rda(data_abund_hell ~ ., data = data_env |> select(latitude, longitude, year_quant))
anova(rda_quant)
```

Visualize the results :

```{r}
sp_quant <- which(goodness(rda_quant)[, 2] >= 0.35)
rda_coords <- extract_rda(rda_quant, select_spe = sp_quant)
```

```{r}
ggplot() +
  geom_point(data = rda_coords$site_scores, aes(x = RDA1, y = RDA2)) +
  geom_segment(
    data = rda_coords$species_scores,
    aes(
      x = 0,
      y = 0,
      xend = RDA1,
      yend = RDA2
    ),
    arrow = arrow(length = unit(.15, 'cm')),
    color = "red",
    lwd = 0.3,
  ) +
  geom_segment(
    data = rda_coords$env_scores,
    aes(
      x = 0,
      y = 0,
      xend = RDA1,
      yend = RDA2
    ),
    arrow = arrow(length = unit(.15, 'cm')),
    color = "blue",
    lwd = 0.3,
  ) +
  geom_text_repel(
    data = rda_coords$env_scores,
    aes(x = RDA1, y = RDA2, label = rownames(rda_coords$env_scores)),
    color = "blue"
  ) +
  geom_text_repel(
    data = rda_coords$species_scores,
    aes(x = RDA1, y = RDA2, label = rownames(rda_coords$species_scores)),
    color = "red",
    size = 3
  ) +
  labs(
    x = paste0("RDA1 (", rda_coords$var_perc[1], "%)"),
    y = paste0("RDA2 (", rda_coords$var_perc[2], "%)")
  ) +
  annotate(
    "text",
    x = -0.5,
    y = -0.5,
    label = paste0(
      "F = ",
      rda_coords$F,
      "\np-value = ",
      rda_coords$p_value,
      "\nadjusted R² = ",
      rda_coords$r_sq_adj
    )
  ) +
  theme_test()
```

Here we can better see the separation between the years 1996, 1997 and 2000. However, this model and this representation are not better than the qualitative model.

But from this RDA it looks like there is a continuous shift in the community between 1996 and 2000. We could imagine two sets of points for 1998 and 1999 that would fill the empty space in the plot.

## db-MEM analysis

I will also compute a db-MEM to see if there are spatial structures that are more complex than just the x/y coordinates.

Extract latitudes and longitudes of all stations, and get the db-MEMs :

```{r}
stations_xy <- subset(data_env, year == 1996)[c(3, 4)]
dbmem <- dbmem(stations_xy)
```

Add these MEMs to the env dataframe :

```{r}
data_env <- cbind(data_env, as.data.frame(dbmem))
```

Let's visualize the 7 MEMs :

```{r}
data_MEM <- data_env |>
  pivot_longer(MEM1:MEM7, names_to = "MEM", values_to = "value")
```

```{r}
ggplot(data_MEM, aes(x = longitude, y = latitude, size = abs(value), color = factor(sign(value)))) +
  geom_point() +
  facet_wrap(vars(MEM)) +
  theme_test()
```

Before we perform db-MEM analysis, we have to check if there is a linear trend in the data :

```{r}
anova(rda(data_abund_hell, data_env[c(3, 4)]))
```

There is a significant linear trend, so we have to detrend the data before db-MEM.

```{r}
data_abund_detrended <- resid(lm(as.matrix(data_abund_hell) ~ ., data = data_env[c(3, 4)]))
```

Now we can run the db-MEM analysis :

```{r}
dbmem_rda <- rda(data_abund_detrended ~ ., data_env |> select(MEM1:MEM7))
anova(dbmem_rda)
```

```{r}
RsquareAdj(dbmem_rda)$adj.r.squared
```

Run forward selection on the dbmem variables :

```{r}
forward.sel(data_abund_detrended, data_env |> select(MEM1:MEM7))
```

The best model has MEM1, MEM3 and MEM6. Now we can do a model with only these MEMs :

```{r}
dbmem_rda_2 <- rda(data_abund_detrended ~ ., data_env |> select(MEM1, MEM3, MEM6))
anova(dbmem_rda_2)
```

Let's check which axes of this RDA are significant :

```{r}
anova(dbmem_rda_2, by = "axis")
```

RDA1 and RDA2 are significant (for $\alpha = 0.05$). RDA3 is not significant by a tiny amount.

Extract the canonical model scores :

```{r}
rda_2_axes <- scores(dbmem_rda_2, choices = c(1, 2), display = "lc", scaling = 1)
```

Plot the significant RDA axes :

```{r}
data_dbmem_rda <- data_env |>
  bind_cols(rda_2_axes) |>
  select(latitude, longitude, RDA1, RDA2) |>
  pivot_longer(RDA1:RDA2, names_to = "axis", values_to = "value")
```

```{r}
ggplot(data_dbmem_rda, aes(x = longitude, y = latitude, size = abs(value), color = sign(value))) +
  geom_point() +
  facet_wrap(vars(axis)) +
  theme_bw()
```

These two spatial structures explain a significant part of the variance of the community composition.